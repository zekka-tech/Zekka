apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco-system
  labels:
    app: falco
    tier: security
spec:
  selector:
    matchLabels:
      app: falco
  template:
    metadata:
      labels:
        app: falco
        tier: security
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9376"
    spec:
      serviceAccountName: falco
      hostNetwork: true
      hostPID: true
      containers:
      - name: falco
        image: falcosecurity/falco:0.36.0
        securityContext:
          privileged: true
        args:
        - /usr/bin/falco
        - --cri
        - /run/containerd/containerd.sock
        - -K
        - /var/run/secrets/kubernetes.io/serviceaccount/token
        - -k
        - https://$(KUBERNETES_SERVICE_HOST)
        - -pk
        env:
        - name: FALCO_GRPC_ENABLED
          value: "true"
        - name: FALCO_GRPC_BIND_ADDRESS
          value: "0.0.0.0:5060"
        - name: KUBERNETES_SERVICE_HOST
          value: kubernetes.default.svc
        volumeMounts:
        - name: containerd-socket
          mountPath: /run/containerd/containerd.sock
        - name: dev
          mountPath: /dev
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: boot
          mountPath: /host/boot
          readOnly: true
        - name: lib-modules
          mountPath: /host/lib/modules
          readOnly: true
        - name: usr
          mountPath: /host/usr
          readOnly: true
        - name: etc
          mountPath: /host/etc
          readOnly: true
        - name: falco-rules
          mountPath: /etc/falco/rules.d
        resources:
          requests:
            memory: "512Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      - name: falco-exporter
        image: falcosecurity/falco-exporter:latest
        ports:
        - containerPort: 9376
          name: metrics
          protocol: TCP
        env:
        - name: FALCO_GRPC_ENDPOINT
          value: "localhost:5060"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: containerd-socket
        hostPath:
          path: /run/containerd/containerd.sock
      - name: dev
        hostPath:
          path: /dev
      - name: proc
        hostPath:
          path: /proc
      - name: boot
        hostPath:
          path: /boot
      - name: lib-modules
        hostPath:
          path: /lib/modules
      - name: usr
        hostPath:
          path: /usr
      - name: etc
        hostPath:
          path: /etc
      - name: falco-rules
        configMap:
          name: falco-custom-rules
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: falco-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: falco
rules:
- apiGroups: [""]
  resources: ["pods", "nodes", "namespaces"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: falco
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: falco
subjects:
- kind: ServiceAccount
  name: falco
  namespace: falco-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-custom-rules
  namespace: falco-system
data:
  zekka-rules.yaml: |
    - rule: Cryptocurrency Mining in Zekka Containers
      desc: Detect cryptocurrency mining activity
      condition: >
        container.name contains "zekka" and
        spawned_process and
        (proc.name in (xmrig, minerd, cpuminer, ethminer, cgminer) or
         proc.cmdline contains "stratum+tcp" or
         proc.cmdline contains "pool.supportxmr" or
         proc.cmdline contains "xmr-node")
      output: >
        Cryptocurrency mining detected (user=%user.name command=%proc.cmdline 
        container=%container.name image=%container.image.repository 
        pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [crypto, mining, malware]
      
    - rule: Reverse Shell in Zekka
      desc: Detect reverse shell connections
      condition: >
        container.name contains "zekka" and
        spawned_process and
        ((proc.name in (nc, ncat, socat, bash, sh, dash) and
          (proc.args contains "-e" or proc.args contains "-c" or
           proc.args contains "/bin/sh" or proc.args contains "/bin/bash")) or
         (proc.name = python and proc.args contains "socket"))
      output: >
        Reverse shell detected (user=%user.name command=%proc.cmdline 
        container=%container.name pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [reverse-shell, intrusion]
      
    - rule: Suspicious File Access in Zekka
      desc: Detect access to sensitive files
      condition: >
        container.name contains "zekka" and
        (fd.name in (/etc/shadow, /etc/passwd, /etc/sudoers) or
         fd.directory in (/root/.ssh, /home/*/.ssh) or
         fd.name contains "id_rsa" or
         fd.name contains "authorized_keys")
      output: >
        Suspicious file access (file=%fd.name user=%user.name 
        container=%container.name pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [file-access, credential-theft]
      
    - rule: Privilege Escalation Attempt
      desc: Detect privilege escalation attempts
      condition: >
        container.name contains "zekka" and
        spawned_process and
        (proc.name in (sudo, su, setuid) or
         evt.type=execve and evt.arg.flags contains "setuid")
      output: >
        Privilege escalation attempt (user=%user.name command=%proc.cmdline 
        container=%container.name pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [privilege-escalation]
      
    - rule: Unexpected Outbound Connection
      desc: Detect unexpected outbound network connections
      condition: >
        container.name contains "zekka" and
        evt.type=connect and
        fd.sip!="0.0.0.0" and
        not fd.sip in (kubernetes_service_ips) and
        not fd.snet in ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16")
      output: >
        Unexpected outbound connection (destination=%fd.sip:%fd.sport 
        container=%container.name pod=%k8s.pod.name)
      priority: WARNING
      tags: [network, exfiltration]
      
    - rule: Container Running in Privileged Mode
      desc: Detect containers running with privileged flag
      condition: >
        container.name contains "zekka" and
        container.privileged=true and
        not container.name in (falco, node-exporter)
      output: >
        Container running in privileged mode (container=%container.name 
        pod=%k8s.pod.name namespace=%k8s.ns.name)
      priority: WARNING
      tags: [container-security]
      
    - rule: Database Credentials Access
      desc: Detect access to database credential files
      condition: >
        container.name contains "zekka" and
        (fd.name contains ".env" or
         fd.name contains "credentials" or
         fd.name contains "database.yml" or
         fd.name contains "pg_service.conf")
      output: >
        Database credential file accessed (file=%fd.name user=%user.name 
        container=%container.name pod=%k8s.pod.name)
      priority: HIGH
      tags: [credentials, database]
