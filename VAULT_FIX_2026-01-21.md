# Vault Container Health Check Fix - 2026-01-21

## Issue Summary

The Vault container was failing its health check, causing the application container to fail startup with the error:
```
dependency failed to start: container zekka-vault is unhealthy
```

## Root Cause

The `docker-compose.yml` file contained a volume mount referencing a non-existent directory:
```yaml
volumes:
  - vault-data:/vault/data
  - ./vault/config:/vault/config  # ❌ This directory doesn't exist
```

When Docker tried to mount `./vault/config` to `/vault/config` inside the container, it failed because the host directory doesn't exist. This caused Vault to fail its health check.

## Solution

Removed the unnecessary `./vault/config:/vault/config` volume mount from the Vault service configuration in `docker-compose.yml`.

**Why this works:**
- Vault running in dev mode (with `-dev` flag) doesn't require a config directory
- All configuration is handled through environment variables and command-line flags
- The `vault-data` volume is sufficient for storing Vault's data

## Changes Made

### Modified File: `docker-compose.yml`

**Before:**
```yaml
vault:
  volumes:
    - vault-data:/vault/data
    - ./vault/config:/vault/config  # ❌ Problematic mount
```

**After:**
```yaml
vault:
  volumes:
    - vault-data:/vault/data  # ✅ Only necessary mount
```

## Testing Instructions

After pulling the latest changes, test the fix:

```bash
# Pull latest code
git pull origin main

# Stop existing containers
docker-compose down

# Remove old containers and volumes (optional, for clean start)
docker-compose down -v

# Start services
docker-compose up -d

# Check Vault health
docker-compose ps vault

# Verify Vault is healthy
curl http://localhost:8200/v1/sys/health

# Check application started successfully
docker-compose ps app
curl http://localhost:3000/health
```

## Expected Results

1. ✅ Vault container starts successfully
2. ✅ Vault health check passes (status: healthy)
3. ✅ Redis container remains healthy
4. ✅ Application container starts successfully (no longer blocked by vault dependency)

## Additional Notes

### Vault Configuration

The Vault service is configured for **development mode** with:
- Dev server mode: `server -dev`
- Root token: `${VAULT_DEV_ROOT_TOKEN:-zekka-dev-token}`
- Listen address: `0.0.0.0:8200`
- Health check endpoint: `http://localhost:8200/v1/sys/health`

### Production Considerations

For production deployment:
1. Don't use `-dev` mode
2. Create a proper `vault/config` directory with production config
3. Use proper unsealing mechanism
4. Enable TLS/HTTPS
5. Implement proper backup strategy for `vault-data` volume

See [VAULT_SETUP.md](VAULT_SETUP.md) for detailed production deployment instructions.

## Related Files

- `docker-compose.yml` - Main Docker Compose configuration
- `VAULT_SETUP.md` - Vault integration documentation
- `.env.example` - Environment variable examples including Vault config

## Commit Details

- **Commit**: `3875fea`
- **Message**: "fix(docker): remove missing vault config directory mount causing health check failure"
- **Date**: 2026-01-21
- **Branch**: main

## Prevention

To prevent similar issues in the future:

1. **Always check directory existence** before adding volume mounts
2. **Use conditional mounts** for optional directories:
   ```yaml
   # Only mount if directory exists
   volumes:
     - vault-data:/vault/data
     ${VAULT_CONFIG_DIR:+- ${VAULT_CONFIG_DIR}:/vault/config}
   ```
3. **Document required directories** in README or setup scripts
4. **Add pre-flight checks** in startup scripts to verify required paths exist

## Support

If you encounter any issues after applying this fix:

1. Check Docker logs: `docker-compose logs vault`
2. Verify health status: `docker-compose ps`
3. Check system resources: `docker stats`
4. Review this document and [VAULT_SETUP.md](VAULT_SETUP.md)
5. Open an issue on GitHub with relevant logs

---

**Status**: ✅ **RESOLVED**  
**Severity**: High (blocked application startup)  
**Impact**: Application can now start successfully with Vault service
